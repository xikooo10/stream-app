<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuickPick Stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">
  <meta name="description" content="QuickPick premium sports streaming platform">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
  <link rel="preload" as="image" href="logo__1_.png">
  <link rel="manifest" href="manifest.json">
  
  <style>
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --bg-primary: #000000;
      --bg-secondary: #0f0f0f;
      --bg-tertiary: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #666666;
      --accent-primary: #b5ff00;
      --accent-secondary: #8fcc00;
      --error-color: #ff4444;
      --border-color: #1a1a1a;
      --live-indicator: #ff0000;
    }
    
    body {
      background: var(--bg-primary) url('X_pick.png') center center no-repeat fixed;
      background-size: cover;
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      line-height: 1.5;
      margin: 0;
      padding: 0;
    }

    #header {
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--border-color);
      padding: 6px 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.8);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      max-height: none;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--accent-primary) var(--bg-secondary);
    }

    #header::-webkit-scrollbar {
      width: 6px;
    }

    #header::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    #header::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 3px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .header-logo {
      height: 28px;
      width: 28px;
      filter: drop-shadow(0 0 10px rgba(181, 255, 0, 0.3));
      border-radius: 50%;
    }

    .header-controls {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
    }

    #current-channel {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-primary);
      text-shadow: 0 0 10px rgba(181, 255, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #search-box {
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 11px;
      width: 140px;
      transition: all 0.3s;
    }

    #search-box:focus {
      outline: none;
      border-color: var(--accent-primary);
      width: 180px;
      box-shadow: 0 0 15px rgba(181, 255, 0, 0.15);
    }

    .btn {
      padding: 4px 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
      transition: all 0.3s;
      font-family: inherit;
    }

    .btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      box-shadow: 0 0 15px rgba(181, 255, 0, 0.2);
    }

    .btn:active {
      transform: scale(0.98);
    }

    #logout-btn:hover {
      border-color: var(--error-color);
      color: var(--error-color);
    }

    .filter-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 3px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .filter-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .filter-tab.active {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      color: #000;
      border-color: var(--accent-primary);
      font-weight: 600;
    }

    /* Live Matches Section */
    #live-matches-section {
      background: rgba(15, 15, 15, 0.9);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      padding: 6px;
      margin-bottom: 6px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-primary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .live-count {
      font-size: 10px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .live-indicator {
      display: inline-block;
      width: 5px;
      height: 5px;
      background: var(--live-indicator);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    #live-matches {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 4px 2px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent-primary) var(--bg-secondary);
      scroll-behavior: smooth;
      max-height: 110px;
    }

    #live-matches::-webkit-scrollbar {
      height: 6px;
    }

    #live-matches::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    #live-matches::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border-radius: 3px;
    }

    .match-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px;
      transition: all 0.3s;
      position: relative;
      min-width: 200px;
      max-width: 200px;
      flex-shrink: 0;
      cursor: pointer;
    }

    .match-card:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      box-shadow: 0 4px 15px rgba(181, 255, 0, 0.3);
      transform: translateY(-2px);
    }

    .match-card.active {
      background: linear-gradient(135deg, rgba(181, 255, 0, 0.15) 0%, rgba(143, 204, 0, 0.15) 100%);
      border-color: var(--accent-primary);
      box-shadow: 0 0 20px rgba(181, 255, 0, 0.4);
    }

    .match-time-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: var(--live-indicator);
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(255, 0, 0, 0.3);
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      padding-top: 14px;
    }

    .match-league {
      font-size: 9px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }

    .match-status {
      font-size: 9px;
      color: var(--accent-primary);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .match-teams {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    .match-team {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      font-size: 11px;
      font-weight: 600;
    }

    .team-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .match-stream-selector {
      margin-top: 4px;
    }

    .stream-selector {
      padding: 3px 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      color: var(--text-secondary);
      font-size: 9px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-weight: 500;
      width: 100%;
      font-family: inherit;
    }

    .stream-selector:hover {
      border-color: var(--accent-primary);
      background: #141414;
      color: var(--accent-primary);
    }

    .stream-selector:focus {
      outline: none;
      border-color: var(--accent-primary);
      color: var(--text-primary);
      box-shadow: 0 0 10px rgba(181, 255, 0, 0.2);
    }

    .no-streams-msg {
      font-size: 9px;
      color: var(--text-secondary);
      text-align: center;
      padding: 4px;
      font-style: italic;
    }

    .no-matches {
      text-align: center;
      padding: 20px 10px;
      color: var(--text-secondary);
      font-size: 11px;
    }

    .loading-matches {
      text-align: center;
      padding: 20px 10px;
      color: var(--text-secondary);
      font-size: 11px;
    }

    #channels {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 4px;
      max-height: 90px;
      overflow-y: auto;
      padding: 3px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent-primary) var(--bg-secondary);
    }

    #channels::-webkit-scrollbar {
      width: 6px;
    }

    #channels::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    #channels::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border-radius: 3px;
    }

    #channels::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #c9ff33 0%, var(--accent-primary) 100%);
    }

    .channel-wrapper {
      display: flex;
      flex-direction: column;
      gap: 3px;
      position: relative;
    }

    .channel-btn {
      padding: 6px 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 600;
      transition: all 0.3s;
      white-space: nowrap;
      position: relative;
      width: 100%;
      font-family: inherit;
    }

    .channel-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-primary);
      transform: translateY(-1px);
      box-shadow: 0 2px 10px rgba(181, 255, 0, 0.3);
    }

    .channel-btn:active {
      transform: translateY(0);
    }

    .channel-btn.active {
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border-color: var(--accent-primary);
      color: #000000;
      box-shadow: 0 0 15px rgba(181, 255, 0, 0.4);
      font-weight: 700;
    }

    .channel-btn.active::before {
      content: "‚ö°";
      position: absolute;
      left: 4px;
      font-size: 9px;
    }

    .folder-selector {
      padding: 2px 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      color: var(--text-secondary);
      font-size: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-weight: 500;
      width: 100%;
      font-family: inherit;
    }

    .folder-selector:hover {
      border-color: var(--accent-primary);
      background: #141414;
      color: var(--accent-primary);
    }

    .folder-selector:focus {
      outline: none;
      border-color: var(--accent-primary);
      color: var(--text-primary);
      box-shadow: 0 0 10px rgba(181, 255, 0, 0.2);
    }

    #player-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100vh;
      background: var(--bg-primary);
      padding-top: 0;
      z-index: 1;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Fullscreen mode for iframe */
    iframe:fullscreen,
    iframe:-webkit-full-screen,
    iframe:-moz-full-screen,
    iframe:-ms-fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      max-width: 100vw !important;
      max-height: 100vh !important;
      margin: 0 !important;
      padding: 0 !important;
      object-fit: contain;
    }

    /* Manual fullscreen mode for iOS - hide header */
    body.manual-fullscreen #header {
      display: none;
    }

    body.manual-fullscreen {
      overflow: hidden !important;
    }

    .overlay-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
      display: none;
    }

    #loading.show,
    #error-msg.show {
      display: block;
    }

    .spinner {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--accent-primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
      box-shadow: 0 0 20px rgba(181, 255, 0, 0.3);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #error-msg {
      color: var(--error-color);
      max-width: 400px;
      padding: 20px;
    }

    .reconnect-info {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    #controls-overlay {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      border: 2px solid var(--border-color);
      padding: 10px 18px;
      border-radius: 10px;
      display: flex;
      gap: 12px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 20;
      box-shadow: 0 4px 30px rgba(0,0,0,0.8);
    }

    #player-container:hover #controls-overlay {
      opacity: 1;
    }

    .control-btn {
      background: none;
      border: none;
      color: var(--accent-primary);
      font-size: 24px;
      cursor: pointer;
      padding: 6px;
      transition: all 0.2s;
      filter: drop-shadow(0 0 5px rgba(181, 255, 0, 0.3));
    }

    .control-btn:hover {
      transform: scale(1.3);
      filter: drop-shadow(0 0 10px rgba(181, 255, 0, 0.6));
    }

    .control-btn:active {
      transform: scale(1.1);
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: 2px solid var(--accent-primary);
      color: var(--text-primary);
      padding: 10px 18px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(181, 255, 0, 0.3);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      font-weight: 600;
      pointer-events: none;
      max-width: 280px;
      font-size: 12px;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .shortcut-hint {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0,0,0,0.9);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 100;
      font-weight: 500;
    }

    .shortcut-hint.show {
      opacity: 1;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      #header {
        padding: 5px 8px;
      }

      .header-top {
        flex-direction: column;
        gap: 6px;
        align-items: stretch;
      }

      .header-logo {
        height: 24px;
        width: 24px;
        margin: 0 auto;
      }

      .header-controls {
        justify-content: center;
      }

      #search-box {
        width: 100%;
      }

      #search-box:focus {
        width: 100%;
      }

      #current-channel {
        font-size: 10px;
        text-align: center;
        justify-content: center;
      }

      #live-matches {
        gap: 4px;
        max-height: 100px;
      }

      .match-card {
        min-width: 180px;
        max-width: 180px;
        padding: 5px;
      }

      #channels {
        grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
        max-height: 80px;
      }

      .channel-btn {
        padding: 5px 6px;
        font-size: 9px;
      }

      .folder-selector {
        font-size: 7px;
        padding: 2px 3px;
      }

      #controls-overlay {
        opacity: 1;
      }

      .shortcut-hint {
        display: block;
        font-size: 10px;
        padding: 6px 10px;
      }
    }

    @media (max-width: 768px) and (orientation: landscape) {
      #header {
        padding: 4px 6px;
      }

      .channel-btn {
        padding: 4px 6px;
        font-size: 8px;
      }

      #channels {
        max-height: 60px;
      }

      #live-matches {
        max-height: 85px;
      }

      .match-card {
        min-width: 160px;
        max-width: 160px;
      }
    }
  </style>
</head>
<body>

<div id="app">
  <header id="header">
    <div class="header-top">
      <img src="logo__1_.png" alt="QuickPick Logo" class="header-logo" width="48" height="48">
      <div class="header-controls">
        <input 
          type="search" 
          id="search-box" 
          placeholder="üîç Search teams, channels..." 
          aria-label="Search teams and channels"
        >
        <button id="refresh-btn" class="btn" title="Refresh stream (R)" aria-label="Refresh stream">
          üîÑ Refresh
        </button>
        <button id="fullscreen-btn" class="btn" title="Fullscreen (F)" aria-label="Toggle fullscreen">
          ‚õ∂ Full
        </button>
        <button id="logout-btn" class="btn" title="Logout" aria-label="Logout">
          üö™ Logout
        </button>
      </div>
    </div>

    <div id="current-channel" aria-live="polite">‚ö° Select a channel to start</div>

    <!-- Live Matches Section -->
    <div id="live-matches-section">
      <div class="section-header">
        <div class="section-title">
          üî¥ LIVE MATCHES <span class="live-count">Live (0)</span>
        </div>
        <button id="refresh-matches-btn" class="btn" style="padding: 3px 6px; font-size: 9px;" title="Refresh live matches">
          üîÑ
        </button>
      </div>
      <div id="live-matches">
        <div class="loading-matches">
          <div class="spinner" style="width: 35px; height: 35px; margin: 8px auto;"></div>
          Loading live matches...
        </div>
      </div>
    </div>

    <!-- Section Divider -->
    <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>

    <!-- Channels Section Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
      <div style="font-size: 11px; font-weight: 700; color: var(--text-primary);">
        üì∫ TV CHANNELS
      </div>
    </div>

    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All Channels</button>
      <button class="filter-tab" data-filter="sport">Sport TV</button>
      <button class="filter-tab" data-filter="dazn">DAZN</button>
    </div>

    <div id="channels" role="list" aria-label="Channel list"></div>
  </header>

  <main id="player-container">
    <div id="loading" class="overlay-message" role="status" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <div>Loading stream...</div>
      <small style="color: var(--text-secondary); margin-top: 8px; display: block;">This may take a few seconds</small>
    </div>
    <div id="error-msg" class="overlay-message" role="alert">
      <p style="font-size: 40px; margin: 0;" aria-hidden="true">‚ö†Ô∏è</p>
      <p style="margin: 10px 0;">Stream unavailable</p>
      <small>Try another channel or refresh</small>
      <div class="reconnect-info" id="reconnect-info"></div>
    </div>
    <iframe 
      id="player" 
      allowfullscreen 
      webkitallowfullscreen
      mozallowfullscreen
      title="Stream player"
      style="border: 0;"
    ></iframe>
    
    <div id="controls-overlay" role="group" aria-label="Playback controls">
      <button class="control-btn" id="prev-btn" title="Previous channel (‚Üê)" aria-label="Previous channel">
        ‚èÆ
      </button>
      <button class="control-btn" id="next-btn" title="Next channel (‚Üí)" aria-label="Next channel">
        ‚è≠
      </button>
    </div>
  </main>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="shortcut-hint" class="shortcut-hint" aria-hidden="true">
  Press F for fullscreen ‚Ä¢ ‚Üê ‚Üí to switch channels ‚Ä¢ R to refresh
</div>

<script>
'use strict';

// ========== STREAMLINED AD PROTECTION (NON-INTERFERING) ==========
(function() {
  console.log('üõ°Ô∏è Initializing protection...');
  
  // Block window.open
  window.open = function() {
    console.warn('üö´ Blocked window.open');
    return null;
  };
  
  // Block window.opener
  try {
    Object.defineProperty(window, 'opener', {
      get: () => null,
      set: () => {},
      configurable: false
    });
  } catch(e) {}
  
  // Block popunders
  let lastBlur = 0;
  window.addEventListener('blur', function() {
    const now = Date.now();
    if (now - lastBlur < 1000) {
      setTimeout(() => window.focus(), 1);
    }
    lastBlur = now;
  });
  
  // Block suspicious external links
  document.addEventListener('click', function(e) {
    const anchor = e.target.closest('a');
    if (anchor && anchor.href) {
      const href = anchor.href;
      if (href.startsWith('http') && !href.includes(window.location.hostname)) {
        e.preventDefault();
        e.stopPropagation();
        console.warn('üö´ Blocked external link:', href);
        return false;
      }
    }
  }, true);
  
  // Block context menu on iframe
  document.addEventListener('contextmenu', function(e) {
    if (e.target.tagName === 'IFRAME') {
      e.preventDefault();
      return false;
    }
  });
  
  // Monitor for injected iframes
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      mutation.addedNodes.forEach(function(node) {
        if (node.tagName === 'IFRAME' && node.id !== 'player') {
          node.remove();
          console.warn('üö´ Removed injected iframe');
        }
      });
    });
  });
  
  if (document.body) {
    observer.observe(document.body, { childList: true, subtree: true });
  }
  
  console.log('‚úÖ Protection active');
})();

// ========== MAIN APPLICATION ==========
const CONFIG = {
  LAST_CHANNEL_KEY: 'lastChannel',
  STREAM_BASE_URL: 'https://dlhd.link',
  WATCHFOOTY_API_BASE: 'https://api.watchfooty.st/api/v1',
  DEBOUNCE_DELAY: 300,
  LOADING_TIMEOUT: 3000,
  RECONNECT_MAX_ATTEMPTS: 3,
  RECONNECT_DELAY: 5000,
  LIVE_MATCHES_REFRESH_INTERVAL: 15000 // Refresh every 15 seconds for aggressive updates
};

// We'll fetch popular leagues from the API instead of hardcoding
let POPULAR_LEAGUES = [];

const channels = [
  { name: "SPORT TV1", id: 49, category: "sport" },
  { name: "SPORT TV2", id: 74, category: "sport" },
  { name: "SPORT TV3", id: 454, category: "sport" },
  { name: "SPORT TV4", id: 289, category: "sport" },
  { name: "SPORT TV5", id: 290, category: "sport" },
  { name: "SPORT TV6", id: 291, category: "sport" },
  { name: "DAZN 1", id: 455, category: "dazn" },
  { name: "DAZN 2", id: 456, category: "dazn" },
  { name: "DAZN 3", id: 457, category: "dazn" },
  { name: "DAZN 4", id: 458, category: "dazn" },
  { name: "DAZN 5", id: 459, category: "dazn" },
  { name: "BTV", id: 380, category: "other" }
];

const folders = ["stream", "watch", "player", "cast", "casting", "plus"];

const elements = {
  channelsDiv: document.getElementById("channels"),
  searchBox: document.getElementById("search-box"),
  currentChannelDiv: document.getElementById("current-channel"),
  player: document.getElementById("player"),
  loading: document.getElementById("loading"),
  errorMsg: document.getElementById("error-msg"),
  reconnectInfo: document.getElementById("reconnect-info"),
  fullscreenBtn: document.getElementById("fullscreen-btn"),
  refreshBtn: document.getElementById("refresh-btn"),
  prevBtn: document.getElementById("prev-btn"),
  nextBtn: document.getElementById("next-btn"),
  toast: document.getElementById("toast"),
  shortcutHint: document.getElementById("shortcut-hint"),
  logoutBtn: document.getElementById("logout-btn"),
  liveMatchesDiv: document.getElementById("live-matches"),
  refreshMatchesBtn: document.getElementById("refresh-matches-btn")
};

const state = {
  currentButton: null,
  currentChannelId: null,
  currentChannelIndex: 0,
  visibleChannels: [...channels],
  loadingTimer: null,
  currentFilter: 'all',
  liveMatches: [],
  currentMatchCard: null,
  liveMatchesRefreshTimer: null,
  currentMatch: null,
  currentStreamIndex: 0
};

const utils = {
  debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  },

  adjustPlayerPosition() {
    const header = document.getElementById('header');
    const playerContainer = document.getElementById('player-container');
    if (header && playerContainer) {
      const headerHeight = header.offsetHeight;
      playerContainer.style.paddingTop = `${headerHeight}px`;
    }
  },

  showToast(message, duration = 2000) {
    elements.toast.textContent = message;
    elements.toast.classList.add("show");
    setTimeout(() => {
      elements.toast.classList.remove("show");
    }, duration);
  },

  getStreamUrl(id, folder) {
    return `${CONFIG.STREAM_BASE_URL}/${folder}/stream-${id}.php`;
  },

  saveToLocalStorage(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
      console.error("Failed to save to localStorage", e);
    }
  },

  loadFromLocalStorage(key, defaultValue = null) {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
      console.error("Failed to load from localStorage", e);
      return defaultValue;
    }
  },

  isTargetLeague(leagueName) {
    if (POPULAR_LEAGUES.length === 0) return true; // Show all if popular leagues not loaded yet
    
    return POPULAR_LEAGUES.some(popularLeague => 
      leagueName.toLowerCase().includes(popularLeague.toLowerCase()) ||
      popularLeague.toLowerCase().includes(leagueName.toLowerCase())
    );
  },

  async fetchPopularLeagues() {
    try {
      console.log('üîÑ Fetching popular football leagues...');
      const response = await fetch(`${CONFIG.WATCHFOOTY_API_BASE}/top-leagues/football`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('‚úÖ Received popular leagues:', data.length);
      
      POPULAR_LEAGUES = data;
      return data;
    } catch (error) {
      console.error('‚ùå Error fetching popular leagues:', error);
      // Fallback to the 6 major European leagues if API fails
      POPULAR_LEAGUES = [
        'Premier League',
        'English Premier League',
        'La Liga',
        'Spanish La Liga',
        'Serie A',
        'Italian Serie A',
        'Bundesliga',
        'German Bundesliga',
        'Ligue 1',
        'French Ligue 1',
        'Primeira Liga',
        'Portuguese Primeira Liga',
        'Liga Portugal',
        'UEFA Champions League',
        'UEFA Europa League'
      ];
      return POPULAR_LEAGUES;
    }
  },

  formatLisbonTime(timestamp) {
    try {
      const date = new Date(timestamp * 1000); // Convert Unix timestamp to milliseconds
      
      // Format to Lisbon timezone (Europe/Lisbon)
      const options = {
        timeZone: 'Europe/Lisbon',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      };
      
      return date.toLocaleTimeString('en-GB', options);
    } catch (error) {
      console.error('Error formatting time:', error);
      return '--:--';
    }
  },

  formatMatchDate(timestamp) {
    try {
      const date = new Date(timestamp * 1000);
      const now = new Date();
      
      // Check if match is today
      const isToday = date.toDateString() === now.toDateString();
      
      // Check if match is tomorrow
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const isTomorrow = date.toDateString() === tomorrow.toDateString();
      
      if (isToday) return 'Today';
      if (isTomorrow) return 'Tomorrow';
      
      // Otherwise show the date
      const options = {
        timeZone: 'Europe/Lisbon',
        month: 'short',
        day: 'numeric'
      };
      
      return date.toLocaleDateString('en-GB', options);
    } catch (error) {
      console.error('Error formatting date:', error);
      return '';
    }
  }
};

const reconnect = {
  attempts: 0,
  timer: null,
  
  start() {
    if (this.attempts >= CONFIG.RECONNECT_MAX_ATTEMPTS) {
      player.showError();
      elements.reconnectInfo.textContent = `Failed after ${CONFIG.RECONNECT_MAX_ATTEMPTS} attempts`;
      return;
    }
    
    this.attempts++;
    elements.reconnectInfo.textContent = `Reconnecting... (${this.attempts}/${CONFIG.RECONNECT_MAX_ATTEMPTS})`;
    utils.showToast(`Reconnecting... (${this.attempts}/${CONFIG.RECONNECT_MAX_ATTEMPTS})`, 3000);
    
    this.timer = setTimeout(() => {
      player.refresh();
    }, CONFIG.RECONNECT_DELAY);
  },
  
  reset() {
    this.attempts = 0;
    clearTimeout(this.timer);
    elements.reconnectInfo.textContent = '';
  }
};

const player = {
  showLoading() {
    elements.loading.classList.add("show");
    elements.errorMsg.classList.remove("show");
    
    clearTimeout(state.loadingTimer);
    state.loadingTimer = setTimeout(() => {
      this.hideLoading();
    }, CONFIG.LOADING_TIMEOUT);
  },

  hideLoading() {
    elements.loading.classList.remove("show");
    clearTimeout(state.loadingTimer);
  },

  showError() {
    elements.loading.classList.remove("show");
    elements.errorMsg.classList.add("show");
  },

  play(id, wrapper, channelName) {
    this.showLoading();
    reconnect.reset();

    if (state.currentButton) {
      state.currentButton.classList.remove("active");
    }
    
    if (state.currentMatchCard) {
      state.currentMatchCard.classList.remove("active");
    }

    const button = wrapper.querySelector('.channel-btn');
    state.currentButton = button;
    button.classList.add("active");

    state.currentChannelId = id;
    state.currentChannelIndex = state.visibleChannels.findIndex(ch => ch.id === id);
    elements.currentChannelDiv.textContent = `‚ö° ${channelName}`;

    const selector = wrapper.querySelector("select");
    const folder = selector ? selector.value : folders[0];

    elements.player.src = utils.getStreamUrl(id, folder);

    utils.saveToLocalStorage(CONFIG.LAST_CHANNEL_KEY, id);
    utils.showToast(`‚ö° Now playing: ${channelName}`);
  },

  playMatch(match, streamIndex = 0) {
    this.showLoading();
    reconnect.reset();

    if (state.currentButton) {
      state.currentButton.classList.remove("active");
    }

    if (state.currentMatchCard) {
      state.currentMatchCard.classList.remove("active");
    }

    const matchCard = document.querySelector(`[data-match-id="${match.matchId}"]`);
    if (matchCard) {
      state.currentMatchCard = matchCard;
      matchCard.classList.add("active");
    }

    state.currentChannelId = null;
    state.currentMatch = match;
    state.currentStreamIndex = streamIndex;
    
    const matchTitle = `${match.teams.home.name} vs ${match.teams.away.name}`;
    const stream = match.streams[streamIndex];
    const streamInfo = stream ? ` (${stream.quality || 'HD'} - ${stream.language || 'EN'})` : '';
    elements.currentChannelDiv.textContent = `‚öΩ ${matchTitle}${streamInfo}`;

    // Use the selected stream
    if (match.streams && match.streams.length > streamIndex) {
      elements.player.src = stream.url;
      utils.showToast(`‚öΩ Now watching: ${matchTitle}${streamInfo}`);
    } else {
      this.showError();
      utils.showToast("Stream not available");
    }
  },

  refresh() {
    if (state.currentChannelId) {
      this.showLoading();
      const currentSrc = elements.player.src;
      elements.player.src = "";
      setTimeout(() => {
        elements.player.src = currentSrc;
      }, 100);
      utils.showToast("üîÑ Refreshing stream...");
    } else if (elements.player.src) {
      // Refresh live match
      this.showLoading();
      const currentSrc = elements.player.src;
      elements.player.src = "";
      setTimeout(() => {
        elements.player.src = currentSrc;
      }, 100);
      utils.showToast("üîÑ Refreshing stream...");
    }
  },

  next() {
    if (state.visibleChannels.length === 0) return;
    
    state.currentChannelIndex = (state.currentChannelIndex + 1) % state.visibleChannels.length;
    const nextChannel = state.visibleChannels[state.currentChannelIndex];
    const wrapper = document.querySelector(`[data-channel-id="${nextChannel.id}"]`);
    if (wrapper) {
      this.play(nextChannel.id, wrapper, nextChannel.name);
    }
  },

  prev() {
    if (state.visibleChannels.length === 0) return;
    
    state.currentChannelIndex = (state.currentChannelIndex - 1 + state.visibleChannels.length) % state.visibleChannels.length;
    const prevChannel = state.visibleChannels[state.currentChannelIndex];
    const wrapper = document.querySelector(`[data-channel-id="${prevChannel.id}"]`);
    if (wrapper) {
      this.play(prevChannel.id, wrapper, prevChannel.name);
    }
  },

  toggleFullscreen() {
    const iframe = document.getElementById("player");
    
    if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
      // Enter fullscreen
      if (iframe.requestFullscreen) {
        iframe.requestFullscreen();
      } else if (iframe.webkitRequestFullscreen) {
        iframe.webkitRequestFullscreen();
      } else if (iframe.mozRequestFullScreen) {
        iframe.mozRequestFullScreen();
      } else if (iframe.msRequestFullscreen) {
        iframe.msRequestFullscreen();
      }
    } else {
      // Exit fullscreen
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
  }
};

const liveMatches = {
  async fetchLiveMatches() {
    try {
      const currentTime = new Date();
      console.log('üîÑ Fetching live popular football matches at:', currentTime.toLocaleTimeString());
      
      // Add cache-busting parameter to ensure fresh data
      const cacheBuster = `?_t=${Date.now()}`;
      const url = `${CONFIG.WATCHFOOTY_API_BASE}/matches/football/popular/live${cacheBuster}`;
      
      console.log('üì° Fetching from:', url);
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('‚úÖ Received', data.length, 'matches at', new Date().toLocaleTimeString());
      
      if (data.length > 0) {
        console.log('üìã Sample match data:', {
          league: data[0].league,
          home: data[0].teams?.home?.name,
          away: data[0].teams?.away?.name,
          minute: data[0].currentMinute,
          timestamp: data[0].timestamp,
          streams: data[0].streams?.length || 0
        });
      } else {
        console.warn('‚ö†Ô∏è No live matches returned from API');
      }
      
      // Preserve existing match data to maintain start times
      const existingMatches = new Map(state.liveMatches.map(m => [m.matchId, m]));
      
      // Process new matches and preserve start times
      const processedMatches = data.map(match => {
        const existing = existingMatches.get(match.matchId);
        if (existing && existing.fetchedAt) {
          // Keep the original fetch time for accurate minute calculation
          return { ...match, fetchedAt: existing.fetchedAt };
        } else {
          // New match - record when we first saw it
          return { ...match, fetchedAt: Date.now() };
        }
      });
      
      // Sort by league name for better organization
      const sortedMatches = processedMatches.sort((a, b) => {
        // First sort by league
        if (a.league < b.league) return -1;
        if (a.league > b.league) return 1;
        // Then by timestamp
        return a.timestamp - b.timestamp;
      });
      
      // Log what changed
      const oldMatchIds = new Set(state.liveMatches.map(m => m.matchId));
      const newMatchIds = new Set(sortedMatches.map(m => m.matchId));
      const added = sortedMatches.filter(m => !oldMatchIds.has(m.matchId));
      const removed = state.liveMatches.filter(m => !newMatchIds.has(m.matchId));
      
      if (added.length > 0) {
        console.log('‚ûï New matches added:', added.map(m => `${m.teams.home.name} vs ${m.teams.away.name}`));
      }
      if (removed.length > 0) {
        console.log('‚ûñ Matches removed:', removed.map(m => `${m.teams.home.name} vs ${m.teams.away.name}`));
      }
      if (added.length === 0 && removed.length === 0 && sortedMatches.length > 0) {
        console.log('üîÑ Match list unchanged');
      }
      
      console.log('üéØ Total live matches:', sortedMatches.length);
      
      // Update live count in UI
      const liveCountSpan = document.querySelector('.live-count');
      if (liveCountSpan) {
        liveCountSpan.textContent = `Live (${sortedMatches.length})`;
      }
      
      state.liveMatches = sortedMatches;
      this.render();
      
      return sortedMatches;
    } catch (error) {
      console.error('‚ùå Error fetching matches:', error);
      this.renderError();
      return [];
    }
  },

  createMatchCard(match) {
    const card = document.createElement('div');
    card.className = 'match-card';
    card.dataset.matchId = match.matchId;
    
    // Simple LIVE badge (no scores shown)
    const timeBadge = `<div class="match-time-badge">LIVE</div>`;
    
    // Filter streams: HD/HD+ quality and ONLY English/Portuguese languages
    const hdStreams = match.streams ? match.streams.filter(stream => {
      const quality = (stream.quality || '').toLowerCase().trim();
      const language = (stream.language || '').toLowerCase().trim();
      
      // Must be HD or HD+ or FHD (not SD or low)
      const isHD = 
        quality.includes('hd') || 
        quality.includes('fhd') ||
        quality === 'high' ||
        quality === '';  // Sometimes HD streams have empty quality
      
      const notSD = !quality.includes('sd') && !quality.includes('low');
      
      // STRICT: Only English or Portuguese
      const isEnglish = 
        language === 'en' || 
        language === 'english' || 
        language === 'eng' ||
        language.startsWith('en-') ||
        language.includes('english');
        
      const isPortuguese = 
        language === 'pt' || 
        language === 'por' ||
        language === 'portuguese' || 
        language.startsWith('pt-') ||
        language.includes('portuguese') ||
        language.includes('portugues');
      
      return (isHD && notSD) && (isEnglish || isPortuguese);
    }) : [];
    
    // Log filtered streams for debugging
    if (match.streams && match.streams.length > 0 && hdStreams.length === 0) {
      console.log(`‚ö†Ô∏è No EN/PT HD streams for ${match.teams.home.name} vs ${match.teams.away.name}`);
      console.log('Available streams:', match.streams.map(s => `${s.quality}-${s.language}`));
    }
    
    // Create streams selector (dropdown style like channels)
    let streamsHTML = '';
    if (hdStreams.length > 0) {
      streamsHTML = `
        <select class="stream-selector" data-match-id="${match.matchId}" aria-label="Select stream quality">
          ${hdStreams.map((stream, index) => {
            const quality = stream.quality || 'HD';
            const language = stream.language || 'EN';
            // Find the original index in the full streams array
            const originalIndex = match.streams.indexOf(stream);
            return `<option value="${originalIndex}">${quality} - ${language}</option>`;
          }).join('')}
        </select>
      `;
    } else {
      streamsHTML = '<div class="no-streams-msg">No EN/PT HD streams</div>';
    }
    
    card.innerHTML = `
      ${timeBadge}
      <div class="match-header">
        <div class="match-league">${match.league}</div>
      </div>
      <div class="match-teams">
        <div class="match-team">
          <span class="team-name">${match.teams.home.name}</span>
        </div>
        <div class="match-team">
          <span class="team-name">${match.teams.away.name}</span>
        </div>
      </div>
      <div class="match-stream-selector">
        ${streamsHTML}
      </div>
    `;
    
    // Add click handler for the entire card (plays first HD stream)
    if (hdStreams.length > 0) {
      card.addEventListener('click', (e) => {
        // Don't trigger if clicking the select dropdown
        if (e.target.classList.contains('stream-selector')) return;
        
        const selector = card.querySelector('.stream-selector');
        const streamIndex = selector ? parseInt(selector.value) : match.streams.indexOf(hdStreams[0]);
        player.playMatch(match, streamIndex);
      });
      
      // Add change handler for stream selector
      const selector = card.querySelector('.stream-selector');
      if (selector) {
        selector.addEventListener('change', (e) => {
          e.stopPropagation();
          const streamIndex = parseInt(e.target.value);
          player.playMatch(match, streamIndex);
        });
      }
    }
    
    return card;
  },

  render() {
    elements.liveMatchesDiv.innerHTML = '';
    
    if (state.liveMatches.length === 0) {
      elements.liveMatchesDiv.innerHTML = `
        <div class="no-matches">
          ‚öΩ No live popular matches at the moment
        </div>
      `;
      // Adjust player position after rendering
      setTimeout(() => utils.adjustPlayerPosition(), 100);
      return;
    }
    
    state.liveMatches.forEach(match => {
      const card = this.createMatchCard(match);
      elements.liveMatchesDiv.appendChild(card);
    });
    
    console.log('‚úÖ Rendered', state.liveMatches.length, 'live match cards');
    
    // Adjust player position after rendering
    setTimeout(() => utils.adjustPlayerPosition(), 100);
  },

  renderError() {
    elements.liveMatchesDiv.innerHTML = `
      <div class="no-matches">
        ‚ö†Ô∏è Unable to load matches. Please check your connection and try refreshing.
      </div>
    `;
  },

  filter(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    
    if (!term) {
      // Show all matches if search is empty
      this.render();
      return;
    }
    
    // Filter matches by team name or league
    const filtered = state.liveMatches.filter(match => {
      const homeTeam = match.teams.home.name.toLowerCase();
      const awayTeam = match.teams.away.name.toLowerCase();
      const league = match.league.toLowerCase();
      
      return homeTeam.includes(term) || 
             awayTeam.includes(term) || 
             league.includes(term);
    });
    
    // Render filtered matches
    elements.liveMatchesDiv.innerHTML = '';
    
    if (filtered.length === 0) {
      elements.liveMatchesDiv.innerHTML = `
        <div class="no-matches">
          üîç No matches found for "${searchTerm}"
        </div>
      `;
      return;
    }
    
    filtered.forEach(match => {
      const card = this.createMatchCard(match);
      elements.liveMatchesDiv.appendChild(card);
    });
    
    console.log(`üîç Filtered to ${filtered.length} matches for term: ${searchTerm}`);
  },

  startAutoRefresh() {
    // Clear existing timer if any
    if (state.liveMatchesRefreshTimer) {
      clearInterval(state.liveMatchesRefreshTimer);
    }
    
    // Set up auto-refresh
    state.liveMatchesRefreshTimer = setInterval(() => {
      console.log('üîÑ Auto-refreshing live matches...');
      this.fetchLiveMatches();
    }, CONFIG.LIVE_MATCHES_REFRESH_INTERVAL);
    
    console.log('‚úÖ Auto-refresh enabled (every 15s)');
  },

  stopAutoRefresh() {
    if (state.liveMatchesRefreshTimer) {
      clearInterval(state.liveMatchesRefreshTimer);
      state.liveMatchesRefreshTimer = null;
      console.log('‚èπÔ∏è Auto-refresh stopped');
    }
  }
};

const channelManager = {
  filter(searchTerm, filterType = state.currentFilter) {
    const term = searchTerm.toLowerCase().trim();
    let filtered = [...channels];
    
    if (filterType !== 'all') {
      filtered = filtered.filter(ch => ch.category === filterType);
    }
    
    if (term) {
      filtered = filtered.filter(ch => 
        ch.name.toLowerCase().includes(term) ||
        ch.category.toLowerCase().includes(term)
      );
    }
    
    state.visibleChannels = filtered;
    this.render();
    
    if (state.visibleChannels.length === 0) {
      utils.showToast("No channels found");
    }
  },

  createButton(channel) {
    const wrapper = document.createElement("div");
    wrapper.className = "channel-wrapper";
    wrapper.dataset.channelId = channel.id;
    wrapper.setAttribute("role", "listitem");

    const btn = document.createElement("button");
    btn.className = "channel-btn";
    btn.textContent = channel.name;
    btn.type = "button";

    const selector = document.createElement("select");
    selector.className = "folder-selector";
    selector.title = "Select stream source";
    selector.setAttribute("aria-label", `Stream source for ${channel.name}`);

    folders.forEach(folder => {
      const option = document.createElement("option");
      option.value = folder;
      option.textContent = folder;
      selector.appendChild(option);
    });

    const savedFolder = utils.loadFromLocalStorage(`channel_${channel.id}_folder`) || folders[0];
    selector.value = savedFolder;

    selector.addEventListener("change", (e) => {
      e.stopPropagation();
      utils.saveToLocalStorage(`channel_${channel.id}_folder`, e.target.value);
      
      if (state.currentChannelId === channel.id) {
        elements.player.src = utils.getStreamUrl(channel.id, e.target.value);
        utils.showToast(`‚ö° Switched to: ${e.target.value}`, 1500);
      }
    });

    btn.onclick = () => player.play(channel.id, wrapper, channel.name);

    wrapper.appendChild(btn);
    wrapper.appendChild(selector);

    return wrapper;
  },

  render() {
    elements.channelsDiv.innerHTML = "";
    
    if (state.visibleChannels.length === 0) {
      elements.channelsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No channels found</p>';
      // Adjust player position after rendering
      setTimeout(() => utils.adjustPlayerPosition(), 100);
      return;
    }
    
    state.visibleChannels.forEach(ch => {
      const wrapper = this.createButton(ch);
      elements.channelsDiv.appendChild(wrapper);
    });
    
    // Adjust player position after rendering
    setTimeout(() => utils.adjustPlayerPosition(), 100);
  }
};

const handlers = {
  logout() {
    if (confirm("Are you sure you want to logout?")) {
      document.cookie = "auth_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT; Secure; SameSite=Strict";
      window.location.href = "/";
    }
  },

  keyboard(e) {
    if (e.target.tagName === "INPUT" || e.target.tagName === "SELECT") return;
    
    switch(e.key) {
      case "f":
      case "F":
        e.preventDefault();
        player.toggleFullscreen();
        break;
      case "ArrowRight":
        e.preventDefault();
        player.next();
        break;
      case "ArrowLeft":
        e.preventDefault();
        player.prev();
        break;
      case "r":
      case "R":
        e.preventDefault();
        player.refresh();
        break;
      case "Escape":
        // Check if in manual fullscreen mode (iOS fallback)
        if (elements.fullscreenBtn.getAttribute('data-manual-fullscreen') === 'true') {
          player.toggleFullscreen();
        } else if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
        break;
    }
  }
};

// Filter tabs
document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    
    const filter = this.dataset.filter;
    state.currentFilter = filter;
    channelManager.filter(elements.searchBox.value, filter);
  });
});

// Initialize
async function init() {
  console.log('üöÄ Initializing app...');
  
  // Detect iOS devices (iPhone, iPad, iPod)
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  
  // Hide fullscreen button on iOS since iframe fullscreen is not supported
  if (isIOS) {
    elements.fullscreenBtn.style.display = 'none';
    console.log('üì± iOS detected - fullscreen button hidden (use embedded player controls)');
  }
  
  channelManager.render();
  
  // Adjust player position based on header height
  utils.adjustPlayerPosition();
  
  // Readjust on window resize
  window.addEventListener('resize', utils.debounce(() => {
    utils.adjustPlayerPosition();
  }, 150));
  
  // Fetch popular leagues first (optional, for fallback filtering)
  await utils.fetchPopularLeagues();
  
  // Fetch popular live matches
  await liveMatches.fetchLiveMatches();
  
  // Start auto-refresh for live matches
  liveMatches.startAutoRefresh();
  
  const lastChannelId = utils.loadFromLocalStorage(CONFIG.LAST_CHANNEL_KEY);
  const defaultChannel = lastChannelId 
    ? channels.find(ch => ch.id == lastChannelId) || channels[0]
    : channels[0];
  
  const defaultWrapper = document.querySelector(`[data-channel-id="${defaultChannel.id}"]`);
  if (defaultWrapper) {
    player.play(defaultChannel.id, defaultWrapper, defaultChannel.name);
  }
  
  setTimeout(() => {
    // Show iOS-specific hint or regular hint
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    
    if (isIOS) {
      elements.shortcutHint.textContent = 'Tap the stream player for fullscreen controls';
    }
    
    elements.shortcutHint.classList.add("show");
    setTimeout(() => elements.shortcutHint.classList.remove("show"), 4000);
  }, 1000);

  // Event listeners
  elements.searchBox.addEventListener("input", 
    utils.debounce((e) => {
      const searchTerm = e.target.value;
      // Search both channels and live matches
      channelManager.filter(searchTerm);
      liveMatches.filter(searchTerm);
    }, CONFIG.DEBOUNCE_DELAY)
  );
  elements.refreshBtn.addEventListener("click", () => player.refresh());
  elements.fullscreenBtn.addEventListener("click", () => player.toggleFullscreen());
  elements.prevBtn.addEventListener("click", () => player.prev());
  elements.nextBtn.addEventListener("click", () => player.next());
  elements.logoutBtn.addEventListener("click", handlers.logout);
  elements.refreshMatchesBtn.addEventListener("click", () => {
    utils.showToast("üîÑ Refreshing matches...");
    liveMatches.fetchLiveMatches().then(() => {
      const now = new Date().toLocaleTimeString();
      utils.showToast(`‚úÖ Updated at ${now}`, 2000);
    });
  });
  document.addEventListener("keydown", handlers.keyboard);

  // Iframe events
  elements.player.addEventListener("load", () => {
    player.hideLoading();
    reconnect.reset();
  });

  elements.player.addEventListener("error", () => {
    reconnect.start();
  });
  
  // iOS manual fullscreen exit on double-tap
  let lastTap = 0;
  elements.player.addEventListener("click", (e) => {
    const now = Date.now();
    const timeSinceLastTap = now - lastTap;
    
    if (timeSinceLastTap < 300 && timeSinceLastTap > 0) {
      // Double tap detected
      if (elements.fullscreenBtn.getAttribute('data-manual-fullscreen') === 'true') {
        player.toggleFullscreen();
      }
    }
    lastTap = now;
  });

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    liveMatches.stopAutoRefresh();
  });

  console.log('‚úÖ App initialized');
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>
