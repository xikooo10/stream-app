<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuickPick Stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
  
  <style>
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --bg-primary: #000000;
      --bg-secondary: #0f0f0f;
      --text-primary: #ffffff;
      --text-secondary: #666666;
      --accent-primary: #b5ff00;
      --border-color: #1a1a1a;
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
    }

    #header {
      background: rgba(0, 0, 0, 0.95);
      border-bottom: 2px solid var(--border-color);
      padding: 6px 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--accent-primary) var(--bg-secondary);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .header-logo {
      height: 28px;
      width: 28px;
      border-radius: 50%;
    }

    .header-controls {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    #current-channel {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-primary);
    }

    #search-box {
      padding: 4px 8px;
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 11px;
      width: 140px;
    }

    #search-box:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .btn {
      padding: 4px 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 600;
      font-family: inherit;
    }

    .btn:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    .filter-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 3px 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      cursor: pointer;
      font-size: 10px;
      color: var(--text-secondary);
    }

    .filter-tab.active {
      background: var(--accent-primary);
      color: #000;
      font-weight: 600;
    }

    #live-matches-section {
      background: rgba(15, 15, 15, 0.9);
      border: 2px solid var(--border-color);
      border-radius: 6px;
      padding: 6px;
      margin-bottom: 6px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-primary);
    }

    #live-matches {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding: 4px 2px;
      max-height: 110px;
    }

    .match-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 6px;
      min-width: 200px;
      max-width: 200px;
      cursor: pointer;
      position: relative;
    }

    .match-card:hover {
      border-color: var(--accent-primary);
    }

    .match-card.active {
      background: linear-gradient(135deg, rgba(181, 255, 0, 0.15) 0%, rgba(143, 204, 0, 0.15) 100%);
      border-color: var(--accent-primary);
    }

    .match-time-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: #ff0000;
      color: #fff;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 700;
    }

    .match-header {
      margin-bottom: 6px;
      padding-top: 14px;
    }

    .match-league {
      font-size: 9px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
    }

    .match-teams {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    .match-team {
      font-size: 11px;
      font-weight: 600;
    }

    .stream-selector {
      padding: 3px 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      color: var(--text-secondary);
      font-size: 9px;
      width: 100%;
      font-family: inherit;
    }

    #channels {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 4px;
      max-height: 90px;
      overflow-y: auto;
      padding: 3px;
    }

    .channel-wrapper {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .channel-btn {
      padding: 6px 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      font-weight: 600;
      width: 100%;
      font-family: inherit;
    }

    .channel-btn:hover {
      border-color: var(--accent-primary);
    }

    .channel-btn.active {
      background: var(--accent-primary);
      color: #000000;
      font-weight: 700;
    }

    .folder-selector {
      padding: 2px 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 3px;
      color: var(--text-secondary);
      font-size: 8px;
      width: 100%;
      font-family: inherit;
    }

    #player-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100vh;
      background: var(--bg-primary);
      z-index: 1;
    }

    #player {
      width: 100%;
      height: 100%;
      border: none;
    }

    @media (max-width: 768px) {
      #header { padding: 5px 8px; }
      .header-top { flex-direction: column; gap: 6px; }
      .header-logo { height: 24px; width: 24px; margin: 0 auto; }
      #search-box { width: 100%; }
      #live-matches { max-height: 100px; }
      .match-card { min-width: 180px; max-width: 180px; }
      #channels { grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); max-height: 80px; }
      .channel-btn { padding: 5px 6px; font-size: 9px; }
    }
  </style>
</head>
<body>

<div id="app">
  <header id="header">
    <div class="header-top">
      <img src="logo__1_.png" alt="QuickPick Logo" class="header-logo">
      <div class="header-controls">
        <input type="search" id="search-box" placeholder="ðŸ” Search...">
        <button id="refresh-btn" class="btn">ðŸ”„ Refresh</button>
        <button id="logout-btn" class="btn">ðŸšª Logout</button>
      </div>
    </div>

    <div id="current-channel">âš¡ Select a channel to start</div>

    <div id="live-matches-section">
      <div class="section-header">
        <div class="section-title">ðŸ”´ LIVE MATCHES <span id="live-count">Live (0)</span></div>
        <button id="refresh-matches-btn" class="btn" style="padding: 3px 6px; font-size: 9px;">ðŸ”„</button>
      </div>
      <div id="live-matches"></div>
    </div>

    <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>

    <div style="font-size: 11px; font-weight: 700; margin-bottom: 4px;">ðŸ“º TV CHANNELS</div>

    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All</button>
      <button class="filter-tab" data-filter="sport">Sport TV</button>
      <button class="filter-tab" data-filter="dazn">DAZN</button>
    </div>

    <div id="channels"></div>
  </header>

  <main id="player-container">
    <iframe 
      id="player" 
      allowfullscreen 
      webkitallowfullscreen 
      mozallowfullscreen 
      msallowfullscreen
      allow="autoplay *; fullscreen *; picture-in-picture *; encrypted-media *; geolocation *; microphone *; camera *"
      sandbox="allow-forms allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-presentation"
    ></iframe>
  </main>
</div>

<script>
'use strict';

const CONFIG = {
  STREAM_BASE_URL: 'https://dlhd.link',
  WATCHFOOTY_API_BASE: 'https://api.watchfooty.st/api/v1',
  LIVE_MATCHES_REFRESH_INTERVAL: 15000
};

const channels = [
  { name: "SPORT TV1", id: 49, category: "sport" },
  { name: "SPORT TV2", id: 74, category: "sport" },
  { name: "SPORT TV3", id: 454, category: "sport" },
  { name: "SPORT TV4", id: 289, category: "sport" },
  { name: "SPORT TV5", id: 290, category: "sport" },
  { name: "SPORT TV6", id: 291, category: "sport" },
  { name: "DAZN 1", id: 455, category: "dazn" },
  { name: "DAZN 2", id: 456, category: "dazn" },
  { name: "DAZN 3", id: 457, category: "dazn" },
  { name: "DAZN 4", id: 458, category: "dazn" },
  { name: "DAZN 5", id: 459, category: "dazn" },
  { name: "BTV", id: 380, category: "other" }
];

const folders = ["stream", "watch", "player", "cast", "casting", "plus"];

const state = {
  currentButton: null,
  currentMatchCard: null,
  visibleChannels: [...channels],
  currentFilter: 'all',
  liveMatches: [],
  refreshTimer: null
};

function getStreamUrl(id, folder) {
  return `${CONFIG.STREAM_BASE_URL}/${folder}/stream-${id}.php`;
}

function adjustPlayerPosition() {
  const header = document.getElementById('header');
  const playerContainer = document.getElementById('player-container');
  if (header && playerContainer) {
    playerContainer.style.paddingTop = header.offsetHeight + 'px';
  }
}

function playChannel(id, wrapper, channelName) {
  if (state.currentButton) {
    state.currentButton.classList.remove("active");
  }
  if (state.currentMatchCard) {
    state.currentMatchCard.classList.remove("active");
  }

  const button = wrapper.querySelector('.channel-btn');
  state.currentButton = button;
  button.classList.add("active");

  const selector = wrapper.querySelector("select");
  const folder = selector ? selector.value : folders[0];

  document.getElementById('player').src = getStreamUrl(id, folder);
  document.getElementById('current-channel').textContent = `âš¡ ${channelName}`;
}

function playMatch(match, streamIndex = 0) {
  if (state.currentButton) {
    state.currentButton.classList.remove("active");
  }
  if (state.currentMatchCard) {
    state.currentMatchCard.classList.remove("active");
  }

  const matchCard = document.querySelector(`[data-match-id="${match.matchId}"]`);
  if (matchCard) {
    state.currentMatchCard = matchCard;
    matchCard.classList.add("active");
  }

  const stream = match.streams[streamIndex];
  const matchTitle = `${match.teams.home.name} vs ${match.teams.away.name}`;
  
  if (stream) {
    document.getElementById('player').src = stream.url;
    document.getElementById('current-channel').textContent = `âš½ ${matchTitle}`;
  }
}

function createMatchCard(match) {
  const card = document.createElement('div');
  card.className = 'match-card';
  card.dataset.matchId = match.matchId;
  
  const hdStreams = match.streams ? match.streams.filter(stream => {
    const quality = (stream.quality || '').toLowerCase().trim();
    const language = (stream.language || '').toLowerCase().trim();
    
    const isHD = quality.includes('hd') || quality.includes('fhd') || quality === 'high' || quality === '';
    const notSD = !quality.includes('sd') && !quality.includes('low');
    
    const isEnglish = language === 'en' || language === 'english' || language === 'eng' || language.startsWith('en-');
    const isPortuguese = language === 'pt' || language === 'por' || language === 'portuguese' || language.startsWith('pt-');
    
    return (isHD && notSD) && (isEnglish || isPortuguese);
  }) : [];
  
  let streamsHTML = '';
  if (hdStreams.length > 0) {
    streamsHTML = `
      <select class="stream-selector">
        ${hdStreams.map((stream, index) => {
          const originalIndex = match.streams.indexOf(stream);
          return `<option value="${originalIndex}">${stream.quality || 'HD'} - ${stream.language || 'EN'}</option>`;
        }).join('')}
      </select>
    `;
  } else {
    streamsHTML = '<div style="font-size:9px;color:#666;">No EN/PT streams</div>';
  }
  
  card.innerHTML = `
    <div class="match-time-badge">LIVE</div>
    <div class="match-header">
      <div class="match-league">${match.league}</div>
    </div>
    <div class="match-teams">
      <div class="match-team">${match.teams.home.name}</div>
      <div class="match-team">${match.teams.away.name}</div>
    </div>
    <div style="margin-top:4px;">${streamsHTML}</div>
  `;
  
  if (hdStreams.length > 0) {
    card.addEventListener('click', (e) => {
      if (e.target.classList.contains('stream-selector')) return;
      const selector = card.querySelector('.stream-selector');
      const streamIndex = selector ? parseInt(selector.value) : match.streams.indexOf(hdStreams[0]);
      playMatch(match, streamIndex);
    });
    
    const selector = card.querySelector('.stream-selector');
    if (selector) {
      selector.addEventListener('change', (e) => {
        e.stopPropagation();
        playMatch(match, parseInt(e.target.value));
      });
    }
  }
  
  return card;
}

async function fetchLiveMatches() {
  try {
    const url = `${CONFIG.WATCHFOOTY_API_BASE}/matches/football/popular/live?_t=${Date.now()}`;
    const response = await fetch(url);
    const data = await response.json();
    
    state.liveMatches = data.sort((a, b) => {
      if (a.league < b.league) return -1;
      if (a.league > b.league) return 1;
      return a.timestamp - b.timestamp;
    });
    
    document.getElementById('live-count').textContent = `Live (${data.length})`;
    
    const container = document.getElementById('live-matches');
    container.innerHTML = '';
    
    if (data.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:#666;font-size:11px;">No live matches</div>';
    } else {
      data.forEach(match => {
        container.appendChild(createMatchCard(match));
      });
    }
    
    setTimeout(adjustPlayerPosition, 100);
  } catch (error) {
    console.error('Error fetching matches:', error);
  }
}

function createChannelButton(channel) {
  const wrapper = document.createElement("div");
  wrapper.className = "channel-wrapper";
  wrapper.dataset.channelId = channel.id;

  const btn = document.createElement("button");
  btn.className = "channel-btn";
  btn.textContent = channel.name;
  btn.onclick = () => playChannel(channel.id, wrapper, channel.name);

  const selector = document.createElement("select");
  selector.className = "folder-selector";
  folders.forEach(folder => {
    const option = document.createElement("option");
    option.value = folder;
    option.textContent = folder;
    selector.appendChild(option);
  });

  wrapper.appendChild(btn);
  wrapper.appendChild(selector);
  return wrapper;
}

function renderChannels() {
  const container = document.getElementById('channels');
  container.innerHTML = "";
  state.visibleChannels.forEach(ch => {
    container.appendChild(createChannelButton(ch));
  });
  setTimeout(adjustPlayerPosition, 100);
}

function filterChannels(searchTerm, filterType) {
  let filtered = [...channels];
  
  if (filterType !== 'all') {
    filtered = filtered.filter(ch => ch.category === filterType);
  }
  
  if (searchTerm) {
    const term = searchTerm.toLowerCase();
    filtered = filtered.filter(ch => ch.name.toLowerCase().includes(term));
  }
  
  state.visibleChannels = filtered;
  renderChannels();
}

// Init
renderChannels();
fetchLiveMatches();
adjustPlayerPosition();

// Auto-refresh matches
state.refreshTimer = setInterval(fetchLiveMatches, CONFIG.LIVE_MATCHES_REFRESH_INTERVAL);

// Events
window.addEventListener('resize', adjustPlayerPosition);

document.getElementById('search-box').addEventListener('input', (e) => {
  filterChannels(e.target.value, state.currentFilter);
});

document.getElementById('refresh-btn').addEventListener('click', () => {
  const iframe = document.getElementById('player');
  const src = iframe.src;
  iframe.src = '';
  setTimeout(() => iframe.src = src, 100);
});

document.getElementById('refresh-matches-btn').addEventListener('click', fetchLiveMatches);

document.getElementById('logout-btn').addEventListener('click', () => {
  if (confirm("Logout?")) {
    document.cookie = "auth_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
    window.location.href = "/";
  }
});

document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    this.classList.add('active');
    state.currentFilter = this.dataset.filter;
    filterChannels(document.getElementById('search-box').value, state.currentFilter);
  });
});

// Play first channel
if (channels.length > 0) {
  const wrapper = document.querySelector(`[data-channel-id="${channels[0].id}"]`);
  if (wrapper) {
    playChannel(channels[0].id, wrapper, channels[0].name);
  }
}
</script>

</body>
</html>
